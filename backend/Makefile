.PHONY: help install dev test lint format clean run init-db

# é»˜è®¤ç›®æ ‡
help: ## æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
	@echo "Markdownè½¬PDF API - å¼€å‘å‘½ä»¤"
	@echo "================================"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)

# å®‰è£…å’Œè®¾ç½®
install: ## å®‰è£…é¡¹ç›®ä¾èµ–
	uv sync

dev: ## å®‰è£…å¼€å‘ä¾èµ–
	uv sync --extra dev

# æ•°æ®åº“æ“ä½œ
init-db: ## åˆå§‹åŒ–æ•°æ®åº“
	uv run python scripts/init_db.py

# è¿è¡ŒæœåŠ¡
run: ## è¿è¡Œå¼€å‘æœåŠ¡å™¨
	uv run python run.py

run-prod: ## è¿è¡Œç”Ÿäº§æœåŠ¡å™¨
	uv run uvicorn app.main:app --host 0.0.0.0 --port 8000

# æµ‹è¯•
test: ## è¿è¡Œæ‰€æœ‰æµ‹è¯•
	uv run pytest

test-cov: ## è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
	uv run pytest --cov=app --cov=db --cov-report=html --cov-report=term

test-watch: ## è¿è¡Œæµ‹è¯•å¹¶ç›‘å¬æ–‡ä»¶å˜åŒ–
	uv run pytest-watch

# ä»£ç è´¨é‡
lint: ## è¿è¡Œä»£ç æ£€æŸ¥
	uv run ruff check .

lint-fix: ## è‡ªåŠ¨ä¿®å¤ä»£ç é—®é¢˜
	uv run ruff check . --fix

format: ## æ ¼å¼åŒ–ä»£ç 
	uv run black .
	uv run isort .

type-check: ## ç±»å‹æ£€æŸ¥
	uv run mypy app db

# æ•°æ®åº“è¿ç§»
migrate: ## åˆ›å»ºæ•°æ®åº“è¿ç§»
	uv run alembic revision --autogenerate -m "$(message)"

migrate-up: ## åº”ç”¨æ•°æ®åº“è¿ç§»
	uv run alembic upgrade head

migrate-down: ## å›æ»šæ•°æ®åº“è¿ç§»
	uv run alembic downgrade -1

# æ¸…ç†
clean: ## æ¸…ç†ä¸´æ—¶æ–‡ä»¶
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	rm -rf build/
	rm -rf dist/
	rm -rf .pytest_cache/
	rm -rf htmlcov/
	rm -rf .coverage
	rm -rf .mypy_cache/

# å¼€å‘å·¥å…·
setup: ## å®Œæ•´é¡¹ç›®è®¾ç½®
	@echo "ğŸš€ è®¾ç½®Markdownè½¬PDF APIé¡¹ç›®..."
	uv sync
	uv run python scripts/init_db.py
	@echo "âœ… é¡¹ç›®è®¾ç½®å®Œæˆï¼"

dev-setup: ## è®¾ç½®å¼€å‘ç¯å¢ƒ
	@echo "ğŸ”§ è®¾ç½®å¼€å‘ç¯å¢ƒ..."
	uv sync --extra dev
	uv run python scripts/init_db.py
	@echo "âœ… å¼€å‘ç¯å¢ƒè®¾ç½®å®Œæˆï¼"

# æ–‡æ¡£
docs: ## ç”ŸæˆAPIæ–‡æ¡£
	@echo "ğŸ“š ç”ŸæˆAPIæ–‡æ¡£..."
	uv run python -c "import uvicorn; from app.main import app; uvicorn.run(app, host='0.0.0.0', port=8000)"

# éƒ¨ç½²
build: ## æ„å»ºé¡¹ç›®
	uv build

publish: ## å‘å¸ƒåˆ°PyPI
	uv publish

# å®‰å…¨
security-check: ## å®‰å…¨æ¼æ´æ£€æŸ¥
	uv run safety check

# æ€§èƒ½
profile: ## æ€§èƒ½åˆ†æ
	uv run python -m cProfile -o profile.stats run.py

# ç›‘æ§
monitor: ## å¯åŠ¨ç›‘æ§
	uv run python -m memory_profiler run.py

# å¸®åŠ©ä¿¡æ¯
help-dev: ## æ˜¾ç¤ºå¼€å‘å‘½ä»¤å¸®åŠ©
	@echo "å¼€å‘å‘½ä»¤:"
	@echo "  make install      - å®‰è£…ä¾èµ–"
	@echo "  make dev          - å®‰è£…å¼€å‘ä¾èµ–"
	@echo "  make run          - è¿è¡Œå¼€å‘æœåŠ¡å™¨"
	@echo "  make test         - è¿è¡Œæµ‹è¯•"
	@echo "  make lint         - ä»£ç æ£€æŸ¥"
	@echo "  make format       - ä»£ç æ ¼å¼åŒ–"
	@echo "  make type-check   - ç±»å‹æ£€æŸ¥"
	@echo "  make clean        - æ¸…ç†ä¸´æ—¶æ–‡ä»¶"
	@echo "  make setup        - å®Œæ•´é¡¹ç›®è®¾ç½®"
	@echo "  make dev-setup    - è®¾ç½®å¼€å‘ç¯å¢ƒ" 